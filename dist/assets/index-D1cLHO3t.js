(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const cs="modulepreload",ls=function(r){return"/"+r},lt={},le=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(t.map(c=>{if(c=ls(c),c in lt)return;lt[c]=!0;const l=c.endsWith(".css"),d=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const h=document.createElement("link");if(h.rel=l?"stylesheet":cs,l||(h.as="script"),h.crossOrigin="",h.href=c,a&&h.setAttribute("nonce",a),document.head.appendChild(h),l)return new Promise((u,f)=>{h.addEventListener("load",u),h.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})},ds=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>le(async()=>{const{default:s}=await Promise.resolve().then(()=>he);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)};class rt extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class hs extends rt{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class us extends rt{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class fs extends rt{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var Ke;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(Ke||(Ke={}));var ps=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};class vs{constructor(e,{headers:t={},customFetch:s,region:n=Ke.Any}={}){this.url=e,this.headers=t,this.region=n,this.fetch=ds(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var s;return ps(this,void 0,void 0,function*(){try{const{headers:n,method:i,body:o}=t;let a={},{region:c}=t;c||(c=this.region),c&&c!=="any"&&(a["x-region"]=c);let l;o&&(n&&!Object.prototype.hasOwnProperty.call(n,"Content-Type")||!n)&&(typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",l=o):typeof o=="string"?(a["Content-Type"]="text/plain",l=o):typeof FormData<"u"&&o instanceof FormData?l=o:(a["Content-Type"]="application/json",l=JSON.stringify(o)));const d=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),n),body:l}).catch(g=>{throw new hs(g)}),h=d.headers.get("x-relay-error");if(h&&h==="true")throw new us(d);if(!d.ok)throw new fs(d);let u=((s=d.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),f;return u==="application/json"?f=yield d.json():u==="application/octet-stream"?f=yield d.blob():u==="text/event-stream"?f=d:u==="multipart/form-data"?f=yield d.formData():f=yield d.text(),{data:f,error:null}}catch(n){return{data:null,error:n}}})}}var B=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function gs(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(s){var n=Object.getOwnPropertyDescriptor(r,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return r[s]}})}),t}var x={},nt={},Le={},Ee={},Re={},xe={},ms=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},de=ms();const _s=de.fetch,It=de.fetch.bind(de),Lt=de.Headers,ys=de.Request,ws=de.Response,he=Object.freeze(Object.defineProperty({__proto__:null,Headers:Lt,Request:ys,Response:ws,default:It,fetch:_s},Symbol.toStringTag,{value:"Module"})),bs=gs(he);var Ue={};Object.defineProperty(Ue,"__esModule",{value:!0});let ks=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};Ue.default=ks;var Rt=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(xe,"__esModule",{value:!0});const Es=Rt(bs),$s=Rt(Ue);let Ss=class{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=Es.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=Object.assign({},this.headers),this.headers[e]=t,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const s=this.fetch;let n=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var o,a,c;let l=null,d=null,h=null,u=i.status,f=i.statusText;if(i.ok){if(this.method!=="HEAD"){const A=await i.text();A===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?d=A:d=JSON.parse(A))}const _=(o=this.headers.Prefer)===null||o===void 0?void 0:o.match(/count=(exact|planned|estimated)/),w=(a=i.headers.get("content-range"))===null||a===void 0?void 0:a.split("/");_&&w&&w.length>1&&(h=parseInt(w[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(d)&&(d.length>1?(l={code:"PGRST116",details:`Results contain ${d.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},d=null,h=null,u=406,f="Not Acceptable"):d.length===1?d=d[0]:d=null)}else{const _=await i.text();try{l=JSON.parse(_),Array.isArray(l)&&i.status===404&&(d=[],l=null,u=200,f="OK")}catch{i.status===404&&_===""?(u=204,f="No Content"):l={message:_}}if(l&&this.isMaybeSingle&&(!((c=l==null?void 0:l.details)===null||c===void 0)&&c.includes("0 rows"))&&(l=null,u=200,f="OK"),l&&this.shouldThrowOnError)throw new $s.default(l)}return{error:l,data:d,count:h,status:u,statusText:f}});return this.shouldThrowOnError||(n=n.catch(i=>{var o,a,c;return{error:{message:`${(o=i==null?void 0:i.name)!==null&&o!==void 0?o:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(a=i==null?void 0:i.stack)!==null&&a!==void 0?a:""}`,hint:"",code:`${(c=i==null?void 0:i.code)!==null&&c!==void 0?c:""}`},data:null,count:null,status:0,statusText:""}})),n.then(e,t)}returns(){return this}overrideTypes(){return this}};xe.default=Ss;var Ts=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Re,"__esModule",{value:!0});const As=Ts(xe);let Os=class extends As.default{select(e){let t=!1;const s=(e??"*").split("").map(n=>/\s/.test(n)&&!t?"":(n==='"'&&(t=!t),n)).join("");return this.url.searchParams.set("select",s),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:s,foreignTable:n,referencedTable:i=n}={}){const o=i?`${i}.order`:"order",a=this.url.searchParams.get(o);return this.url.searchParams.set(o,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${s===void 0?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:s=t}={}){const n=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(n,`${e}`),this}range(e,t,{foreignTable:s,referencedTable:n=s}={}){const i=typeof n>"u"?"offset":`${n}.offset`,o=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(o,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:s=!1,buffers:n=!1,wal:i=!1,format:o="text"}={}){var a;const c=[e?"analyze":null,t?"verbose":null,s?"settings":null,n?"buffers":null,i?"wal":null].filter(Boolean).join("|"),l=(a=this.headers.Accept)!==null&&a!==void 0?a:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${o}; for="${l}"; options=${c};`,o==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}};Re.default=Os;var Ps=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Ee,"__esModule",{value:!0});const js=Ps(Re);let Cs=class extends js.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const s=Array.from(new Set(t)).map(n=>typeof n=="string"&&new RegExp("[,()]").test(n)?`"${n}"`:`${n}`).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:s,type:n}={}){let i="";n==="plain"?i="pl":n==="phrase"?i="ph":n==="websearch"&&(i="w");const o=s===void 0?"":`(${s})`;return this.url.searchParams.append(e,`${i}fts${o}.${t}`),this}match(e){return Object.entries(e).forEach(([t,s])=>{this.url.searchParams.append(t,`eq.${s}`)}),this}not(e,t,s){return this.url.searchParams.append(e,`not.${t}.${s}`),this}or(e,{foreignTable:t,referencedTable:s=t}={}){const n=s?`${s}.or`:"or";return this.url.searchParams.append(n,`(${e})`),this}filter(e,t,s){return this.url.searchParams.append(e,`${t}.${s}`),this}};Ee.default=Cs;var Is=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(Le,"__esModule",{value:!0});const ve=Is(Ee);let Ls=class{constructor(e,{headers:t={},schema:s,fetch:n}){this.url=e,this.headers=t,this.schema=s,this.fetch=n}select(e,{head:t=!1,count:s}={}){const n=t?"HEAD":"GET";let i=!1;const o=(e??"*").split("").map(a=>/\s/.test(a)&&!i?"":(a==='"'&&(i=!i),a)).join("");return this.url.searchParams.set("select",o),s&&(this.headers.Prefer=`count=${s}`),new ve.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:s=!0}={}){const n="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),s||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const o=e.reduce((a,c)=>a.concat(Object.keys(c)),[]);if(o.length>0){const a=[...new Set(o)].map(c=>`"${c}"`);this.url.searchParams.set("columns",a.join(","))}}return new ve.default({method:n,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:s=!1,count:n,defaultToNull:i=!0}={}){const o="POST",a=[`resolution=${s?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&a.push(this.headers.Prefer),n&&a.push(`count=${n}`),i||a.push("missing=default"),this.headers.Prefer=a.join(","),Array.isArray(e)){const c=e.reduce((l,d)=>l.concat(Object.keys(d)),[]);if(c.length>0){const l=[...new Set(c)].map(d=>`"${d}"`);this.url.searchParams.set("columns",l.join(","))}}return new ve.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const s="PATCH",n=[];return this.headers.Prefer&&n.push(this.headers.Prefer),t&&n.push(`count=${t}`),this.headers.Prefer=n.join(","),new ve.default({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",s=[];return e&&s.push(`count=${e}`),this.headers.Prefer&&s.unshift(this.headers.Prefer),this.headers.Prefer=s.join(","),new ve.default({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}};Le.default=Ls;var De={},Be={};Object.defineProperty(Be,"__esModule",{value:!0});Be.version=void 0;Be.version="0.0.0-automated";Object.defineProperty(De,"__esModule",{value:!0});De.DEFAULT_HEADERS=void 0;const Rs=Be;De.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${Rs.version}`};var xt=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(nt,"__esModule",{value:!0});const xs=xt(Le),Us=xt(Ee),Ds=De;let Bs=class Ut{constructor(e,{headers:t={},schema:s,fetch:n}={}){this.url=e,this.headers=Object.assign(Object.assign({},Ds.DEFAULT_HEADERS),t),this.schemaName=s,this.fetch=n}from(e){const t=new URL(`${this.url}/${e}`);return new xs.default(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Ut(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:s=!1,get:n=!1,count:i}={}){let o;const a=new URL(`${this.url}/rpc/${e}`);let c;s||n?(o=s?"HEAD":"GET",Object.entries(t).filter(([d,h])=>h!==void 0).map(([d,h])=>[d,Array.isArray(h)?`{${h.join(",")}}`:`${h}`]).forEach(([d,h])=>{a.searchParams.append(d,h)})):(o="POST",c=t);const l=Object.assign({},this.headers);return i&&(l.Prefer=`count=${i}`),new Us.default({method:o,url:a,headers:l,schema:this.schemaName,body:c,fetch:this.fetch,allowEmpty:!1})}};nt.default=Bs;var ue=B&&B.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(x,"__esModule",{value:!0});x.PostgrestError=x.PostgrestBuilder=x.PostgrestTransformBuilder=x.PostgrestFilterBuilder=x.PostgrestQueryBuilder=x.PostgrestClient=void 0;const Dt=ue(nt);x.PostgrestClient=Dt.default;const Bt=ue(Le);x.PostgrestQueryBuilder=Bt.default;const Mt=ue(Ee);x.PostgrestFilterBuilder=Mt.default;const Nt=ue(Re);x.PostgrestTransformBuilder=Nt.default;const qt=ue(xe);x.PostgrestBuilder=qt.default;const Ft=ue(Ue);x.PostgrestError=Ft.default;var Ms=x.default={PostgrestClient:Dt.default,PostgrestQueryBuilder:Bt.default,PostgrestFilterBuilder:Mt.default,PostgrestTransformBuilder:Nt.default,PostgrestBuilder:qt.default,PostgrestError:Ft.default};const{PostgrestClient:Ns,PostgrestQueryBuilder:ni,PostgrestFilterBuilder:ii,PostgrestTransformBuilder:oi,PostgrestBuilder:ai,PostgrestError:ci}=Ms,qs="2.11.2",Fs={"X-Client-Info":`realtime-js/${qs}`},Js="1.0.0",Jt=1e4,Hs=1e3;var ae;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(ae||(ae={}));var U;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(U||(U={}));var q;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(q||(q={}));var Ve;(function(r){r.websocket="websocket"})(Ve||(Ve={}));var ee;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(ee||(ee={}));class Gs{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const n=t.getUint8(1),i=t.getUint8(2);let o=this.HEADER_LENGTH+2;const a=s.decode(e.slice(o,o+n));o=o+n;const c=s.decode(e.slice(o,o+i));o=o+i;const l=JSON.parse(s.decode(e.slice(o,e.byteLength)));return{ref:null,topic:a,event:c,payload:l}}}class Ht{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var b;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(b||(b={}));const dt=(r,e,t={})=>{var s;const n=(s=t.skipTypes)!==null&&s!==void 0?s:[];return Object.keys(e).reduce((i,o)=>(i[o]=Ws(o,r,e,n),i),{})},Ws=(r,e,t,s)=>{const n=e.find(a=>a.name===r),i=n==null?void 0:n.type,o=t[r];return i&&!s.includes(i)?Gt(i,o):Qe(o)},Gt=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return Qs(e,t)}switch(r){case b.bool:return zs(e);case b.float4:case b.float8:case b.int2:case b.int4:case b.int8:case b.numeric:case b.oid:return Ks(e);case b.json:case b.jsonb:return Vs(e);case b.timestamp:return Ys(e);case b.abstime:case b.date:case b.daterange:case b.int4range:case b.int8range:case b.money:case b.reltime:case b.text:case b.time:case b.timestamptz:case b.timetz:case b.tsrange:case b.tstzrange:return Qe(e);default:return Qe(e)}},Qe=r=>r,zs=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},Ks=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},Vs=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(e){return console.log(`JSON parse error: ${e}`),r}return r},Qs=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,s=r[t];if(r[0]==="{"&&s==="}"){let i;const o=r.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>Gt(e,a))}return r},Ys=r=>typeof r=="string"?r.replace(" ","T"):r,Wt=r=>{let e=r;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")};class qe{constructor(e,t,s={},n=Jt){this.channel=e,this.event=t,this.payload=s,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var ht;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(ht||(ht={}));class ye{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},n=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=ye.syncState(this.state,n,i,o),this.pendingDiffs.forEach(c=>{this.state=ye.syncDiff(this.state,c,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(s.diff,{},n=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=ye.syncDiff(this.state,n,i,o),a())}),this.onJoin((n,i,o)=>{this.channel._trigger("presence",{event:"join",key:n,currentPresences:i,newPresences:o})}),this.onLeave((n,i,o)=>{this.channel._trigger("presence",{event:"leave",key:n,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,n){const i=this.cloneDeep(e),o=this.transformState(t),a={},c={};return this.map(i,(l,d)=>{o[l]||(c[l]=d)}),this.map(o,(l,d)=>{const h=i[l];if(h){const u=d.map(w=>w.presence_ref),f=h.map(w=>w.presence_ref),g=d.filter(w=>f.indexOf(w.presence_ref)<0),_=h.filter(w=>u.indexOf(w.presence_ref)<0);g.length>0&&(a[l]=g),_.length>0&&(c[l]=_)}else a[l]=d}),this.syncDiff(i,{joins:a,leaves:c},s,n)}static syncDiff(e,t,s,n){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),n||(n=()=>{}),this.map(i,(a,c)=>{var l;const d=(l=e[a])!==null&&l!==void 0?l:[];if(e[a]=this.cloneDeep(c),d.length>0){const h=e[a].map(f=>f.presence_ref),u=d.filter(f=>h.indexOf(f.presence_ref)<0);e[a].unshift(...u)}s(a,d,c)}),this.map(o,(a,c)=>{let l=e[a];if(!l)return;const d=c.map(h=>h.presence_ref);l=l.filter(h=>d.indexOf(h.presence_ref)<0),e[a]=l,n(a,l,c),l.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const n=e[s];return"metas"in n?t[s]=n.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[s]=n,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var ut;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(ut||(ut={}));var ft;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(ft||(ft={}));var G;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(G||(G={}));class it{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=U.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new qe(this,q.join,this.params,this.timeout),this.rejoinTimer=new Ht(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=U.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(n=>n.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=U.closed,this.socket._remove(this)}),this._onError(n=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,n),this.state=U.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=U.errored,this.rejoinTimer.scheduleTimeout())}),this._on(q.reply,{},(n,i)=>{this._trigger(this._replyEventName(i),n)}),this.presence=new ye(this),this.broadcastEndpointURL=Wt(this.socket.endPoint)+"/api/broadcast",this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var s,n;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:i,presence:o,private:a}}=this.params;this._onError(d=>e==null?void 0:e(G.CHANNEL_ERROR,d)),this._onClose(()=>e==null?void 0:e(G.CLOSED));const c={},l={broadcast:i,presence:o,postgres_changes:(n=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(d=>d.filter))!==null&&n!==void 0?n:[],private:a};this.socket.accessTokenValue&&(c.access_token=this.socket.accessTokenValue),this.updateJoinPayload(Object.assign({config:l},c)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:d})=>{var h;if(this.socket.setAuth(),d===void 0){e==null||e(G.SUBSCRIBED);return}else{const u=this.bindings.postgres_changes,f=(h=u==null?void 0:u.length)!==null&&h!==void 0?h:0,g=[];for(let _=0;_<f;_++){const w=u[_],{filter:{event:A,schema:L,table:j,filter:C}}=w,E=d&&d[_];if(E&&E.event===A&&E.schema===L&&E.table===j&&E.filter===C)g.push(Object.assign(Object.assign({},w),{id:E.id}));else{this.unsubscribe(),e==null||e(G.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=g,e&&e(G.SUBSCRIBED);return}}).receive("error",d=>{e==null||e(G.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(d).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(G.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this._on(e,t,s)}async send(e,t={}){var s,n;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:o}=e,c={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const l=await this._fetchWithTimeout(this.broadcastEndpointURL,c,(s=t.timeout)!==null&&s!==void 0?s:this.timeout);return await((n=l.body)===null||n===void 0?void 0:n.cancel()),l.ok?"ok":"error"}catch(l){return l.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,c;const l=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||c===void 0)&&c.ack)&&i("ok"),l.receive("ok",()=>i("ok")),l.receive("error",()=>i("error")),l.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=U.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(q.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(s=>{const n=new qe(this,q.leave,{},e);n.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),n.send(),this._canPush()||n.trigger("ok",{})})}async _fetchWithTimeout(e,t,s){const n=new AbortController,i=setTimeout(()=>n.abort(),s),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:n.signal}));return clearTimeout(i),o}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new qe(this,e,t,s);return this._canPush()?n.send():(n.startTimeout(),this.pushBuffer.push(n)),n}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var n,i;const o=e.toLocaleLowerCase(),{close:a,error:c,leave:l,join:d}=q;if(s&&[a,c,l,d].indexOf(o)>=0&&s!==this._joinRef())return;let u=this._onMessage(o,t,s);if(t&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(n=this.bindings.postgres_changes)===null||n===void 0||n.filter(f=>{var g,_,w;return((g=f.filter)===null||g===void 0?void 0:g.event)==="*"||((w=(_=f.filter)===null||_===void 0?void 0:_.event)===null||w===void 0?void 0:w.toLocaleLowerCase())===o}).map(f=>f.callback(u,s)):(i=this.bindings[o])===null||i===void 0||i.filter(f=>{var g,_,w,A,L,j;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in f){const C=f.id,E=(g=f.filter)===null||g===void 0?void 0:g.event;return C&&((_=t.ids)===null||_===void 0?void 0:_.includes(C))&&(E==="*"||(E==null?void 0:E.toLocaleLowerCase())===((w=t.data)===null||w===void 0?void 0:w.type.toLocaleLowerCase()))}else{const C=(L=(A=f==null?void 0:f.filter)===null||A===void 0?void 0:A.event)===null||L===void 0?void 0:L.toLocaleLowerCase();return C==="*"||C===((j=t==null?void 0:t.event)===null||j===void 0?void 0:j.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===o}).map(f=>{if(typeof u=="object"&&"ids"in u){const g=u.data,{schema:_,table:w,commit_timestamp:A,type:L,errors:j}=g;u=Object.assign(Object.assign({},{schema:_,table:w,commit_timestamp:A,eventType:L,new:{},old:{},errors:j}),this._getPayloadRecords(g))}f.callback(u,s)})}_isClosed(){return this.state===U.closed}_isJoined(){return this.state===U.joined}_isJoining(){return this.state===U.joining}_isLeaving(){return this.state===U.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const n=e.toLocaleLowerCase(),i={type:n,filter:t,callback:s};return this.bindings[n]?this.bindings[n].push(i):this.bindings[n]=[i],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]=this.bindings[s].filter(n=>{var i;return!(((i=n.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===s&&it.isEqual(n.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(q.close,{},e)}_onError(e){this._on(q.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=U.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=dt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=dt(e.columns,e.old_record)),t}}const Xs=()=>{},Zs=typeof WebSocket<"u",er=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class tr{constructor(e,t){var s;this.accessTokenValue=null,this.apiKey=null,this.channels=[],this.endPoint="",this.httpEndpoint="",this.headers=Fs,this.params={},this.timeout=Jt,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=Xs,this.conn=null,this.sendBuffer=[],this.serializer=new Gs,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._resolveFetch=i=>{let o;return i?o=i:typeof fetch>"u"?o=(...a)=>le(async()=>{const{default:c}=await Promise.resolve().then(()=>he);return{default:c}},void 0).then(({default:c})=>c(...a)):o=fetch,(...a)=>o(...a)},this.endPoint=`${e}/${Ve.websocket}`,this.httpEndpoint=Wt(e),t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const n=(s=t==null?void 0:t.params)===null||s===void 0?void 0:s.apikey;if(n&&(this.accessTokenValue=n,this.apiKey=n),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,o)=>o(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new Ht(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch),t!=null&&t.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.worker=(t==null?void 0:t.worker)||!1,this.workerUrl=t==null?void 0:t.workerUrl}this.accessToken=(t==null?void 0:t.accessToken)||null}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this.endpointURL(),void 0,{headers:this.headers});return}if(Zs){this.conn=new WebSocket(this.endpointURL()),this.setupConnection();return}this.conn=new sr(this.endpointURL(),void 0,{close:()=>{this.conn=null}}),le(async()=>{const{default:e}=await import("./browser-D6okMtuX.js").then(t=>t.b);return{default:e}},[]).then(({default:e})=>{this.conn=new e(this.endpointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:Js}))}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case ae.connecting:return ee.Connecting;case ae.open:return ee.Open;case ae.closing:return ee.Closing;default:return ee.Closed}}isConnected(){return this.connectionState()===ee.Open}channel(e,t={config:{}}){const s=new it(`realtime:${e}`,t,this);return this.channels.push(s),s}push(e){const{topic:t,event:s,payload:n,ref:i}=e,o=()=>{this.encode(e,a=>{var c;(c=this.conn)===null||c===void 0||c.send(a)})};this.log("push",`${t} ${s} (${i})`,n),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){let t=e||this.accessToken&&await this.accessToken()||this.accessTokenValue;if(t){let s=null;try{s=JSON.parse(atob(t.split(".")[1]))}catch{}if(s&&s.exp&&!(Math.floor(Date.now()/1e3)-s.exp<0))return this.log("auth",`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${s.exp}`),Promise.reject(`InvalidJWTToken: Invalid value for JWT claim "exp" with value ${s.exp}`);this.accessTokenValue=t,this.channels.forEach(n=>{t&&n.updateJoinPayload({access_token:t}),n.joinedOnce&&n._isJoined()&&n._push(q.access_token,{access_token:t})})}}async sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(Hs,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth()}}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:s,event:n,payload:i,ref:o}=t;o&&o===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${s} ${n} ${o&&"("+o+")"||""}`,i),this.channels.filter(a=>a._isMember(s)).forEach(a=>a._trigger(n,i,o)),this.stateChangeCallbacks.message.forEach(a=>a(t))})}async _onConnOpen(){if(this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this.reconnectTimer.reset(),!this.worker)this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs);else{this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(q.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const s=e.match(/\?/)?"&":"?",n=new URLSearchParams(t);return`${e}${s}${n}`}_workerObjectUrl(e){let t;if(e)t=e;else{const s=new Blob([er],{type:"application/javascript"});t=URL.createObjectURL(s)}return t}}class sr{constructor(e,t,s){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=ae.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=s.close}}class ot extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function O(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class rr extends ot{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Ye extends ot{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var nr=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};const zt=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>le(async()=>{const{default:s}=await Promise.resolve().then(()=>he);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)},ir=()=>nr(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield le(()=>Promise.resolve().then(()=>he),void 0)).Response:Response}),Xe=r=>{if(Array.isArray(r))return r.map(t=>Xe(t));if(typeof r=="function"||r!==Object(r))return r;const e={};return Object.entries(r).forEach(([t,s])=>{const n=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[n]=Xe(s)}),e};var se=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};const Fe=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),or=(r,e,t)=>se(void 0,void 0,void 0,function*(){const s=yield ir();r instanceof s&&!(t!=null&&t.noResolveJson)?r.json().then(n=>{e(new rr(Fe(n),r.status||500))}).catch(n=>{e(new Ye(Fe(n),n))}):e(new Ye(Fe(r),r))}),ar=(r,e,t,s)=>{const n={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),s&&(n.body=JSON.stringify(s)),Object.assign(Object.assign({},n),t))};function $e(r,e,t,s,n,i){return se(this,void 0,void 0,function*(){return new Promise((o,a)=>{r(t,ar(e,s,n,i)).then(c=>{if(!c.ok)throw c;return s!=null&&s.noResolveJson?c:c.json()}).then(c=>o(c)).catch(c=>or(c,a,s))})})}function Ie(r,e,t,s){return se(this,void 0,void 0,function*(){return $e(r,"GET",e,t,s)})}function V(r,e,t,s,n){return se(this,void 0,void 0,function*(){return $e(r,"POST",e,s,n,t)})}function cr(r,e,t,s,n){return se(this,void 0,void 0,function*(){return $e(r,"PUT",e,s,n,t)})}function lr(r,e,t,s){return se(this,void 0,void 0,function*(){return $e(r,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),s)})}function Kt(r,e,t,s,n){return se(this,void 0,void 0,function*(){return $e(r,"DELETE",e,s,n,t)})}var R=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};const dr={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},pt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class hr{constructor(e,t={},s,n){this.url=e,this.headers=t,this.bucketId=s,this.fetch=zt(n)}uploadOrUpdate(e,t,s,n){return R(this,void 0,void 0,function*(){try{let i;const o=Object.assign(Object.assign({},pt),n);let a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(o.upsert)});const c=o.metadata;typeof Blob<"u"&&s instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),c&&i.append("metadata",this.encodeMetadata(c)),i.append("",s)):typeof FormData<"u"&&s instanceof FormData?(i=s,i.append("cacheControl",o.cacheControl),c&&i.append("metadata",this.encodeMetadata(c))):(i=s,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,c&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(c)))),n!=null&&n.headers&&(a=Object.assign(Object.assign({},a),n.headers));const l=this._removeEmptyFolders(t),d=this._getFinalPath(l),h=yield this.fetch(`${this.url}/object/${d}`,Object.assign({method:e,body:i,headers:a},o!=null&&o.duplex?{duplex:o.duplex}:{})),u=yield h.json();return h.ok?{data:{path:l,id:u.Id,fullPath:u.Key},error:null}:{data:null,error:u}}catch(i){if(O(i))return{data:null,error:i};throw i}})}upload(e,t,s){return R(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,n){return R(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),o=this._getFinalPath(i),a=new URL(this.url+`/object/upload/sign/${o}`);a.searchParams.set("token",t);try{let c;const l=Object.assign({upsert:pt.upsert},n),d=Object.assign(Object.assign({},this.headers),{"x-upsert":String(l.upsert)});typeof Blob<"u"&&s instanceof Blob?(c=new FormData,c.append("cacheControl",l.cacheControl),c.append("",s)):typeof FormData<"u"&&s instanceof FormData?(c=s,c.append("cacheControl",l.cacheControl)):(c=s,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType);const h=yield this.fetch(a.toString(),{method:"PUT",body:c,headers:d}),u=yield h.json();return h.ok?{data:{path:i,fullPath:u.Key},error:null}:{data:null,error:u}}catch(c){if(O(c))return{data:null,error:c};throw c}})}createSignedUploadUrl(e,t){return R(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const n=Object.assign({},this.headers);t!=null&&t.upsert&&(n["x-upsert"]="true");const i=yield V(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:n}),o=new URL(this.url+i.url),a=o.searchParams.get("token");if(!a)throw new ot("No token returned by API");return{data:{signedUrl:o.toString(),path:e,token:a},error:null}}catch(s){if(O(s))return{data:null,error:s};throw s}})}update(e,t,s){return R(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return R(this,void 0,void 0,function*(){try{return{data:yield V(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(n){if(O(n))return{data:null,error:n};throw n}})}copy(e,t,s){return R(this,void 0,void 0,function*(){try{return{data:{path:(yield V(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(n){if(O(n))return{data:null,error:n};throw n}})}createSignedUrl(e,t,s){return R(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e),i=yield V(this.fetch,`${this.url}/object/sign/${n}`,Object.assign({expiresIn:t},s!=null&&s.transform?{transform:s.transform}:{}),{headers:this.headers});const o=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(n){if(O(n))return{data:null,error:n};throw n}})}createSignedUrls(e,t,s){return R(this,void 0,void 0,function*(){try{const n=yield V(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{data:n.map(o=>Object.assign(Object.assign({},o),{signedUrl:o.signedURL?encodeURI(`${this.url}${o.signedURL}${i}`):null})),error:null}}catch(n){if(O(n))return{data:null,error:n};throw n}})}download(e,t){return R(this,void 0,void 0,function*(){const n=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),o=i?`?${i}`:"";try{const a=this._getFinalPath(e);return{data:yield(yield Ie(this.fetch,`${this.url}/${n}/${a}${o}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(a){if(O(a))return{data:null,error:a};throw a}})}info(e){return R(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const s=yield Ie(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:Xe(s),error:null}}catch(s){if(O(s))return{data:null,error:s};throw s}})}exists(e){return R(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield lr(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(O(s)&&s instanceof Ye){const n=s.originalError;if([400,404].includes(n==null?void 0:n.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),n=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&n.push(i);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",c=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});c!==""&&n.push(c);let l=n.join("&");return l!==""&&(l=`?${l}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${s}${l}`)}}}remove(e){return R(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}list(e,t,s){return R(this,void 0,void 0,function*(){try{const n=Object.assign(Object.assign(Object.assign({},dr),t),{prefix:e||""});return{data:yield V(this.fetch,`${this.url}/object/list/${this.bucketId}`,n,{headers:this.headers},s),error:null}}catch(n){if(O(n))return{data:null,error:n};throw n}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const ur="2.7.1",fr={"X-Client-Info":`storage-js/${ur}`};var re=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};class pr{constructor(e,t={},s){this.url=e,this.headers=Object.assign(Object.assign({},fr),t),this.fetch=zt(s)}listBuckets(){return re(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(O(e))return{data:null,error:e};throw e}})}getBucket(e){return re(this,void 0,void 0,function*(){try{return{data:yield Ie(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return re(this,void 0,void 0,function*(){try{return{data:yield V(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(O(s))return{data:null,error:s};throw s}})}updateBucket(e,t){return re(this,void 0,void 0,function*(){try{return{data:yield cr(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(O(s))return{data:null,error:s};throw s}})}emptyBucket(e){return re(this,void 0,void 0,function*(){try{return{data:yield V(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}deleteBucket(e){return re(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}})}}class vr extends pr{constructor(e,t={},s){super(e,t,s)}from(e){return new hr(this.url,this.headers,e,this.fetch)}}const gr="2.49.8";let me="";typeof Deno<"u"?me="deno":typeof document<"u"?me="web":typeof navigator<"u"&&navigator.product==="ReactNative"?me="react-native":me="node";const mr={"X-Client-Info":`supabase-js-${me}/${gr}`},_r={headers:mr},yr={schema:"public"},wr={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},br={};var kr=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};const Er=r=>{let e;return r?e=r:typeof fetch>"u"?e=It:e=fetch,(...t)=>e(...t)},$r=()=>typeof Headers>"u"?Lt:Headers,Sr=(r,e,t)=>{const s=Er(t),n=$r();return(i,o)=>kr(void 0,void 0,void 0,function*(){var a;const c=(a=yield e())!==null&&a!==void 0?a:r;let l=new n(o==null?void 0:o.headers);return l.has("apikey")||l.set("apikey",r),l.has("Authorization")||l.set("Authorization",`Bearer ${c}`),s(i,Object.assign(Object.assign({},o),{headers:l}))})};var Tr=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};function Ar(r){return r.endsWith("/")?r:r+"/"}function Or(r,e){var t,s;const{db:n,auth:i,realtime:o,global:a}=r,{db:c,auth:l,realtime:d,global:h}=e,u={db:Object.assign(Object.assign({},c),n),auth:Object.assign(Object.assign({},l),i),realtime:Object.assign(Object.assign({},d),o),global:Object.assign(Object.assign(Object.assign({},h),a),{headers:Object.assign(Object.assign({},(t=h==null?void 0:h.headers)!==null&&t!==void 0?t:{}),(s=a==null?void 0:a.headers)!==null&&s!==void 0?s:{})}),accessToken:()=>Tr(this,void 0,void 0,function*(){return""})};return r.accessToken?u.accessToken=r.accessToken:delete u.accessToken,u}const Vt="2.69.1",oe=30*1e3,Ze=3,Je=Ze*oe,Pr="http://localhost:9999",jr="supabase.auth.token",Cr={"X-Client-Info":`gotrue-js/${Vt}`},et="X-Supabase-Api-Version",Qt={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Ir=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Lr=6e5;class at extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function m(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class Rr extends at{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}function xr(r){return m(r)&&r.name==="AuthApiError"}class Yt extends at{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Y extends at{constructor(e,t,s,n){super(e,s,n),this.name=t,this.status=s}}class z extends Y{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Ur(r){return m(r)&&r.name==="AuthSessionMissingError"}class He extends Y{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Oe extends Y{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Pe extends Y{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Dr(r){return m(r)&&r.name==="AuthImplicitGrantRedirectError"}class vt extends Y{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class tt extends Y{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Ge(r){return m(r)&&r.name==="AuthRetryableFetchError"}class gt extends Y{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class we extends Y{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const mt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),_t=` 	
\r=`.split(""),Br=(()=>{const r=new Array(128);for(let e=0;e<r.length;e+=1)r[e]=-1;for(let e=0;e<_t.length;e+=1)r[_t[e].charCodeAt(0)]=-2;for(let e=0;e<mt.length;e+=1)r[mt[e].charCodeAt(0)]=e;return r})();function Xt(r,e,t){const s=Br[r];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function yt(r){const e=[],t=o=>{e.push(String.fromCodePoint(o))},s={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},i=o=>{qr(o,s,t)};for(let o=0;o<r.length;o+=1)Xt(r.charCodeAt(o),n,i);return e.join("")}function Mr(r,e){if(r<=127){e(r);return}else if(r<=2047){e(192|r>>6),e(128|r&63);return}else if(r<=65535){e(224|r>>12),e(128|r>>6&63),e(128|r&63);return}else if(r<=1114111){e(240|r>>18),e(128|r>>12&63),e(128|r>>6&63),e(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function Nr(r,e){for(let t=0;t<r.length;t+=1){let s=r.charCodeAt(t);if(s>55295&&s<=56319){const n=(s-55296)*1024&65535;s=(r.charCodeAt(t+1)-56320&65535|n)+65536,t+=1}Mr(s,e)}}function qr(r,e,t){if(e.utf8seq===0){if(r<=127){t(r);return}for(let s=1;s<6;s+=1)if(!(r>>7-s&1)){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=r&31;else if(e.utf8seq===3)e.codepoint=r&15;else if(e.utf8seq===4)e.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|r&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Fr(r){const e=[],t={queue:0,queuedBits:0},s=n=>{e.push(n)};for(let n=0;n<r.length;n+=1)Xt(r.charCodeAt(n),t,s);return new Uint8Array(e)}function Jr(r){const e=[];return Nr(r,t=>e.push(t)),new Uint8Array(e)}function Hr(r){return Math.round(Date.now()/1e3)+r}function Gr(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r=="x"?e:e&3|8).toString(16)})}const F=()=>typeof window<"u"&&typeof document<"u",X={tested:!1,writable:!1},be=()=>{if(!F())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(X.tested)return X.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),X.tested=!0,X.writable=!0}catch{X.tested=!0,X.writable=!1}return X.writable};function Wr(r){const e={},t=new URL(r);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((n,i)=>{e[i]=n})}catch{}return t.searchParams.forEach((s,n)=>{e[n]=s}),e}const Zt=r=>{let e;return r?e=r:typeof fetch>"u"?e=(...t)=>le(async()=>{const{default:s}=await Promise.resolve().then(()=>he);return{default:s}},void 0).then(({default:s})=>s(...t)):e=fetch,(...t)=>e(...t)},zr=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",es=async(r,e,t)=>{await r.setItem(e,JSON.stringify(t))},je=async(r,e)=>{const t=await r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Ce=async(r,e)=>{await r.removeItem(e)};class Me{constructor(){this.promise=new Me.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Me.promiseConstructor=Promise;function We(r){const e=r.split(".");if(e.length!==3)throw new we("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!Ir.test(e[s]))throw new we("JWT not in base64url format");return{header:JSON.parse(yt(e[0])),payload:JSON.parse(yt(e[1])),signature:Fr(e[2]),raw:{header:e[0],payload:e[1]}}}async function Kr(r){return await new Promise(e=>{setTimeout(()=>e(null),r)})}function Vr(r,e){return new Promise((s,n)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await r(i);if(!e(i,null,o)){s(o);return}}catch(o){if(!e(i,o)){n(o);return}}})()})}function Qr(r){return("0"+r.toString(16)).substr(-2)}function Yr(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=t.length;let n="";for(let i=0;i<56;i++)n+=t.charAt(Math.floor(Math.random()*s));return n}return crypto.getRandomValues(e),Array.from(e,Qr).join("")}async function Xr(r){const t=new TextEncoder().encode(r),s=await crypto.subtle.digest("SHA-256",t),n=new Uint8Array(s);return Array.from(n).map(i=>String.fromCharCode(i)).join("")}async function Zr(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const t=await Xr(r);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function ne(r,e,t=!1){const s=Yr();let n=s;t&&(n+="/PASSWORD_RECOVERY"),await es(r,`${e}-code-verifier`,n);const i=await Zr(s);return[i,s===i?"plain":"s256"]}const en=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function tn(r){const e=r.headers.get(et);if(!e||!e.match(en))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function sn(r){if(!r)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(r<=e)throw new Error("JWT has expired")}function rn(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}var nn=function(r,e){var t={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&e.indexOf(s)<0&&(t[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(r);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(r,s[n])&&(t[s[n]]=r[s[n]]);return t};const Z=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),on=[502,503,504];async function wt(r){var e;if(!zr(r))throw new tt(Z(r),0);if(on.includes(r.status))throw new tt(Z(r),r.status);let t;try{t=await r.json()}catch(i){throw new Yt(Z(i),i)}let s;const n=tn(r);if(n&&n.getTime()>=Qt["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?s=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(s=t.error_code),s){if(s==="weak_password")throw new gt(Z(t),r.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new z}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new gt(Z(t),r.status,t.weak_password.reasons);throw new Rr(Z(t),r.status||500,s)}const an=(r,e,t,s)=>{const n={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),n.body=JSON.stringify(s),Object.assign(Object.assign({},n),t))};async function y(r,e,t,s){var n;const i=Object.assign({},s==null?void 0:s.headers);i[et]||(i[et]=Qt["2024-01-01"].name),s!=null&&s.jwt&&(i.Authorization=`Bearer ${s.jwt}`);const o=(n=s==null?void 0:s.query)!==null&&n!==void 0?n:{};s!=null&&s.redirectTo&&(o.redirect_to=s.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",c=await cn(r,e,t+a,{headers:i,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(c):{data:Object.assign({},c),error:null}}async function cn(r,e,t,s,n,i){const o=an(e,s,n,i);let a;try{a=await r(t,Object.assign({},o))}catch(c){throw console.error(c),new tt(Z(c),0)}if(a.ok||await wt(a),s!=null&&s.noResolveJson)return a;try{return await a.json()}catch(c){await wt(c)}}function K(r){var e;let t=null;un(r)&&(t=Object.assign({},r),r.expires_at||(t.expires_at=Hr(r.expires_in)));const s=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:s},error:null}}function bt(r){const e=K(r);return!e.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((t,s)=>t&&typeof s=="string",!0)&&(e.data.weak_password=r.weak_password),e}function Q(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function ln(r){return{data:r,error:null}}function dn(r){const{action_link:e,email_otp:t,hashed_token:s,redirect_to:n,verification_type:i}=r,o=nn(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:s,redirect_to:n,verification_type:i},c=Object.assign({},o);return{data:{properties:a,user:c},error:null}}function hn(r){return r}function un(r){return r.access_token&&r.refresh_token&&r.expires_in}var fn=function(r,e){var t={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&e.indexOf(s)<0&&(t[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(r);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(r,s[n])&&(t[s[n]]=r[s[n]]);return t};class pn{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=Zt(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await y(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(m(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,t={}){try{return await y(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:Q})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:t}=e,s=fn(e,["options"]),n=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(n.new_email=s==null?void 0:s.newEmail,delete n.newEmail),await y(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:dn,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(m(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await y(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Q})}catch(t){if(m(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,s,n,i,o,a,c;try{const l={nextPage:null,lastPage:0,total:0},d=await y(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(i=(n=e==null?void 0:e.perPage)===null||n===void 0?void 0:n.toString())!==null&&i!==void 0?i:""},xform:hn});if(d.error)throw d.error;const h=await d.json(),u=(o=d.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(c=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(g=>{const _=parseInt(g.split(";")[0].split("=")[1].substring(0,1)),w=JSON.parse(g.split(";")[1].split("=")[1]);l[`${w}Page`]=_}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},h),l),error:null}}catch(l){if(m(l))return{data:{users:[]},error:l};throw l}}async getUserById(e){try{return await y(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Q})}catch(t){if(m(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await y(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:Q})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,t=!1){try{return await y(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:Q})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){try{const{data:t,error:s}=await y(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:n=>({data:{factors:n},error:null})});return{data:t,error:s}}catch(t){if(m(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await y(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(m(t))return{data:null,error:t};throw t}}}const vn={getItem:r=>be()?globalThis.localStorage.getItem(r):null,setItem:(r,e)=>{be()&&globalThis.localStorage.setItem(r,e)},removeItem:r=>{be()&&globalThis.localStorage.removeItem(r)}};function kt(r={}){return{getItem:e=>r[e]||null,setItem:(e,t)=>{r[e]=t},removeItem:e=>{delete r[e]}}}function gn(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const ie={debug:!!(globalThis&&be()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class ts extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class mn extends ts{}async function _n(r,e,t){ie.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),ie.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async n=>{if(n){ie.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,n.name);try{return await t()}finally{ie.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,n.name)}}else{if(e===0)throw ie.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new mn(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(ie.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}gn();const yn={url:Pr,storageKey:jr,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Cr,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function Et(r,e,t){return await t()}class ke{constructor(e){var t,s;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=ke.nextInstanceID,ke.nextInstanceID+=1,this.instanceID>0&&F()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const n=Object.assign(Object.assign({},yn),e);if(this.logDebugMessages=!!n.debug,typeof n.debug=="function"&&(this.logger=n.debug),this.persistSession=n.persistSession,this.storageKey=n.storageKey,this.autoRefreshToken=n.autoRefreshToken,this.admin=new pn({url:n.url,headers:n.headers,fetch:n.fetch}),this.url=n.url,this.headers=n.headers,this.fetch=Zt(n.fetch),this.lock=n.lock||Et,this.detectSessionInUrl=n.detectSessionInUrl,this.flowType=n.flowType,this.hasCustomAuthorizationHeader=n.hasCustomAuthorizationHeader,n.lock?this.lock=n.lock:F()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=_n:this.lock=Et,this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?n.storage?this.storage=n.storage:be()?this.storage=vn:(this.memoryStorage={},this.storage=kt(this.memoryStorage)):(this.memoryStorage={},this.storage=kt(this.memoryStorage)),F()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${Vt}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=Wr(window.location.href);let s="none";if(this._isImplicitGrantCallback(t)?s="implicit":await this._isPKCECallback(t)&&(s="pkce"),F()&&this.detectSessionInUrl&&s!=="none"){const{data:n,error:i}=await this._getSessionFromURL(t,s);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Dr(i)){const c=(e=i.details)===null||e===void 0?void 0:e.code;if(c==="identity_already_exists"||c==="identity_not_found"||c==="single_identity_not_deletable")return{error:i}}return await this._removeSession(),{error:i}}const{session:o,redirectType:a}=n;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return m(t)?{error:t}:{error:new Yt("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,s,n;try{const i=await y(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(n=e==null?void 0:e.options)===null||n===void 0?void 0:n.captchaToken}},xform:K}),{data:o,error:a}=i;if(a||!o)return{data:{user:null,session:null},error:a};const c=o.session,l=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",c)),{data:{user:l,session:c},error:null}}catch(i){if(m(i))return{data:{user:null,session:null},error:i};throw i}}async signUp(e){var t,s,n;try{let i;if("email"in e){const{email:d,password:h,options:u}=e;let f=null,g=null;this.flowType==="pkce"&&([f,g]=await ne(this.storage,this.storageKey)),i=await y(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:u==null?void 0:u.emailRedirectTo,body:{email:d,password:h,data:(t=u==null?void 0:u.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken},code_challenge:f,code_challenge_method:g},xform:K})}else if("phone"in e){const{phone:d,password:h,options:u}=e;i=await y(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:h,data:(s=u==null?void 0:u.data)!==null&&s!==void 0?s:{},channel:(n=u==null?void 0:u.channel)!==null&&n!==void 0?n:"sms",gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:K})}else throw new Oe("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return{data:{user:null,session:null},error:a};const c=o.session,l=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",c)),{data:{user:l,session:c},error:null}}catch(i){if(m(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:a}=e;t=await y(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:bt})}else if("phone"in e){const{phone:i,password:o,options:a}=e;t=await y(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},xform:bt})}else throw new Oe("You must provide either an email or phone number and a password");const{data:s,error:n}=t;return n?{data:{user:null,session:null},error:n}:!s||!s.session||!s.user?{data:{user:null,session:null},error:new He}:(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:n})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,s,n,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(n=e.options)===null||n===void 0?void 0:n.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await je(this.storage,`${this.storageKey}-code-verifier`),[s,n]=(t??"").split("/");try{const{data:i,error:o}=await y(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:K});if(await Ce(this.storage,`${this.storageKey}-code-verifier`),o)throw o;return!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new He}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:n??null}),error:o})}catch(i){if(m(i))return{data:{user:null,session:null,redirectType:null},error:i};throw i}}async signInWithIdToken(e){try{const{options:t,provider:s,token:n,access_token:i,nonce:o}=e,a=await y(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:n,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:K}),{data:c,error:l}=a;return l?{data:{user:null,session:null},error:l}:!c||!c.session||!c.user?{data:{user:null,session:null},error:new He}:(c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),{data:c,error:l})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,s,n,i,o;try{if("email"in e){const{email:a,options:c}=e;let l=null,d=null;this.flowType==="pkce"&&([l,d]=await ne(this.storage,this.storageKey));const{error:h}=await y(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=c==null?void 0:c.data)!==null&&t!==void 0?t:{},create_user:(s=c==null?void 0:c.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:l,code_challenge_method:d},redirectTo:c==null?void 0:c.emailRedirectTo});return{data:{user:null,session:null},error:h}}if("phone"in e){const{phone:a,options:c}=e,{data:l,error:d}=await y(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(n=c==null?void 0:c.data)!==null&&n!==void 0?n:{},create_user:(i=c==null?void 0:c.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(o=c==null?void 0:c.channel)!==null&&o!==void 0?o:"sms"}});return{data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d}}throw new Oe("You must provide either an email or phone number.")}catch(a){if(m(a))return{data:{user:null,session:null},error:a};throw a}}async verifyOtp(e){var t,s;try{let n,i;"options"in e&&(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:o,error:a}=await y(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:n,xform:K});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const c=o.session,l=o.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),{data:{user:l,session:c},error:null}}catch(n){if(m(n))return{data:{user:null,session:null},error:n};throw n}}async signInWithSSO(e){var t,s,n;try{let i=null,o=null;return this.flowType==="pkce"&&([i,o]=await ne(this.storage,this.storageKey)),await y(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&s!==void 0?s:void 0}),!((n=e==null?void 0:e.options)===null||n===void 0)&&n.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:o}),headers:this.headers,xform:ln})}catch(i){if(m(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new z;const{error:n}=await y(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:n}})}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:n,options:i}=e,{error:o}=await y(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:n,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:o}}else if("phone"in e){const{phone:s,type:n,options:i}=e,{data:o,error:a}=await y(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:n,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:o==null?void 0:o.message_id},error:a}}throw new Oe("You must provide either an email or phone number and a type")}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),n=(async()=>(await s,await t()))();return this.pendingInLock.push((async()=>{try{await n}catch{}})()),n}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=t();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const n=[...this.pendingInLock];await Promise.all(n),this.pendingInLock.splice(0,n.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await je(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<Je:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.storage.isServer){let o=this.suppressGetSessionWarning;e=new Proxy(e,{get:(c,l,d)=>(!o&&l==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),o=!0,this.suppressGetSessionWarning=!0),Reflect.get(c,l,d))})}return{data:{session:e},error:null}}const{session:n,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:n},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await y(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Q}):await this._useSession(async t=>{var s,n,i;const{data:o,error:a}=t;if(a)throw a;return!(!((s=o.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new z}:await y(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(n=o.session)===null||n===void 0?void 0:n.access_token)!==null&&i!==void 0?i:void 0,xform:Q})})}catch(t){if(m(t))return Ur(t)&&(await this._removeSession(),await Ce(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async s=>{const{data:n,error:i}=s;if(i)throw i;if(!n.session)throw new z;const o=n.session;let a=null,c=null;this.flowType==="pkce"&&e.email!=null&&([a,c]=await ne(this.storage,this.storageKey));const{data:l,error:d}=await y(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:c}),jwt:o.access_token,xform:Q});if(d)throw d;return o.user=l.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),{data:{user:o.user},error:null}})}catch(s){if(m(s))return{data:{user:null},error:s};throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new z;const t=Date.now()/1e3;let s=t,n=!0,i=null;const{payload:o}=We(e.access_token);if(o.exp&&(s=o.exp,n=s<=t),n){const{session:a,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return{data:{user:null,session:null},error:c};if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:c}=await this._getUser(e.access_token);if(c)throw c;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(m(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var s;if(!e){const{data:o,error:a}=t;if(a)throw a;e=(s=o.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new z;const{session:n,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:n?{data:{user:n.user,session:n},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(m(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!F())throw new Pe("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Pe(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new vt("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Pe("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new vt("No code detected.");const{data:L,error:j}=await this._exchangeCodeForSession(e.code);if(j)throw j;const C=new URL(window.location.href);return C.searchParams.delete("code"),window.history.replaceState(window.history.state,"",C.toString()),{data:{session:L.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:n,access_token:i,refresh_token:o,expires_in:a,expires_at:c,token_type:l}=e;if(!i||!a||!o||!l)throw new Pe("No session defined in URL");const d=Math.round(Date.now()/1e3),h=parseInt(a);let u=d+h;c&&(u=parseInt(c));const f=u-d;f*1e3<=oe&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${h}s`);const g=u-h;d-g>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",g,u,d):d-g<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",g,u,d);const{data:_,error:w}=await this._getUser(i);if(w)throw w;const A={provider_token:s,provider_refresh_token:n,access_token:i,expires_in:h,expires_at:u,refresh_token:o,token_type:l,user:_.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:A,redirectType:e.type},error:null}}catch(s){if(m(s))return{data:{session:null,redirectType:null},error:s};throw s}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await je(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var s;const{data:n,error:i}=t;if(i)return{error:i};const o=(s=n.session)===null||s===void 0?void 0:s.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(xr(a)&&(a.status===404||a.status===401||a.status===403)))return{error:a}}return e!=="others"&&(await this._removeSession(),await Ce(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=Gr(),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,n;try{const{data:{session:i},error:o}=t;if(o)throw o;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let s=null,n=null;this.flowType==="pkce"&&([s,n]=await ne(this.storage,this.storageKey,!0));try{return await y(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:n,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(m(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(m(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:s,error:n}=await this._useSession(async i=>{var o,a,c,l,d;const{data:h,error:u}=i;if(u)throw u;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await y(this.fetch,"GET",f,{headers:this.headers,jwt:(d=(l=h.session)===null||l===void 0?void 0:l.access_token)!==null&&d!==void 0?d:void 0})});if(n)throw n;return F()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),{data:{provider:e.provider,url:s==null?void 0:s.url},error:null}}catch(s){if(m(s))return{data:{provider:e.provider,url:null},error:s};throw s}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var s,n;const{data:i,error:o}=t;if(o)throw o;return await y(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(n=(s=i.session)===null||s===void 0?void 0:s.access_token)!==null&&n!==void 0?n:void 0})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const s=Date.now();return await Vr(async n=>(n>0&&await Kr(200*Math.pow(2,n-1)),this._debug(t,"refreshing attempt",n),await y(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:K})),(n,i)=>{const o=200*Math.pow(2,n);return i&&Ge(i)&&Date.now()+o-s<oe})}catch(s){if(this._debug(t,"error",s),m(s))return{data:{session:null,user:null},error:s};throw s}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),F()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const s=await je(this.storage,this.storageKey);if(this._debug(t,"session from storage",s),!this._isValidSession(s)){this._debug(t,"session is not valid"),s!==null&&await this._removeSession();return}const n=((e=s.expires_at)!==null&&e!==void 0?e:1/0)*1e3-Date.now()<Je;if(this._debug(t,`session has${n?"":" not"} expired with margin of ${Je}s`),n){if(this.autoRefreshToken&&s.refresh_token){const{error:i}=await this._callRefreshToken(s.refresh_token);i&&(console.error(i),Ge(i)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(t,"error",s),console.error(s);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new z;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new Me;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new z;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={session:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(n,"error",i),m(i)){const o={session:null,error:i};return Ge(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(i),i}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(e,t,s=!0){const n=`#_notifyAllSubscribers(${e})`;this._debug(n,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(c){i.push(c)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(n,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await es(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await Ce(this.storage,this.storageKey),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&F()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),oe);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const n=Math.floor((s.expires_at*1e3-e)/oe);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts ${oe}ms, refresh threshold is ${Ze} ticks`),n<=Ze&&await this._callRefreshToken(s.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof ts)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!F()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const n=[`provider=${encodeURIComponent(t)}`];if(s!=null&&s.redirectTo&&n.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&n.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[i,o]=await ne(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});n.push(a.toString())}if(s!=null&&s.queryParams){const i=new URLSearchParams(s.queryParams);n.push(i.toString())}return s!=null&&s.skipBrowserRedirect&&n.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${n.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var s;const{data:n,error:i}=t;return i?{data:null,error:i}:await y(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var s,n;const{data:i,error:o}=t;if(o)return{data:null,error:o};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:c,error:l}=await y(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(s=i==null?void 0:i.session)===null||s===void 0?void 0:s.access_token});return l?{data:null,error:l}:(e.factorType==="totp"&&(!((n=c==null?void 0:c.totp)===null||n===void 0)&&n.qr_code)&&(c.totp.qr_code=`data:image/svg+xml;utf-8,${c.totp.qr_code}`),{data:c,error:null})})}catch(t){if(m(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:i}=t;if(i)return{data:null,error:i};const{data:o,error:a}=await y(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});return a?{data:null,error:a}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),{data:o,error:a})})}catch(t){if(m(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:i}=t;return i?{data:null,error:i}:await y(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(m(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const s=(e==null?void 0:e.factors)||[],n=s.filter(o=>o.factor_type==="totp"&&o.status==="verified"),i=s.filter(o=>o.factor_type==="phone"&&o.status==="verified");return{data:{all:s,totp:n,phone:i},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,s;const{data:{session:n},error:i}=e;if(i)return{data:null,error:i};if(!n)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:o}=We(n.access_token);let a=null;o.aal&&(a=o.aal);let c=a;((s=(t=n.user.factors)===null||t===void 0?void 0:t.filter(h=>h.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(c="aal2");const d=o.amr||[];return{data:{currentLevel:a,nextLevel:c,currentAuthenticationMethods:d},error:null}}))}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(o=>o.kid===e);if(s||(s=this.jwks.keys.find(o=>o.kid===e),s&&this.jwks_cached_at+Lr>Date.now()))return s;const{data:n,error:i}=await y(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;if(!n.keys||n.keys.length===0)throw new we("JWKS is empty");if(this.jwks=n,this.jwks_cached_at=Date.now(),s=n.keys.find(o=>o.kid===e),!s)throw new we("No matching signing key found in JWKS");return s}async getClaims(e,t={keys:[]}){try{let s=e;if(!s){const{data:f,error:g}=await this.getSession();if(g||!f.session)return{data:null,error:g};s=f.session.access_token}const{header:n,payload:i,signature:o,raw:{header:a,payload:c}}=We(s);if(sn(i.exp),!n.kid||n.alg==="HS256"||!("crypto"in globalThis&&"subtle"in globalThis.crypto)){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:i,header:n,signature:o},error:null}}const l=rn(n.alg),d=await this.fetchJwk(n.kid,t),h=await crypto.subtle.importKey("jwk",d,l,!0,["verify"]);if(!await crypto.subtle.verify(l,h,o,Jr(`${a}.${c}`)))throw new we("Invalid JWT signature");return{data:{claims:i,header:n,signature:o},error:null}}catch(s){if(m(s))return{data:null,error:s};throw s}}}ke.nextInstanceID=0;const wn=ke;class bn extends wn{constructor(e){super(e)}}var kn=function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{l(s.next(d))}catch(h){o(h)}}function c(d){try{l(s.throw(d))}catch(h){o(h)}}function l(d){d.done?i(d.value):n(d.value).then(a,c)}l((s=s.apply(r,e||[])).next())})};class En{constructor(e,t,s){var n,i,o;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const a=Ar(e),c=new URL(a);this.realtimeUrl=new URL("realtime/v1",c),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",c),this.storageUrl=new URL("storage/v1",c),this.functionsUrl=new URL("functions/v1",c);const l=`sb-${c.hostname.split(".")[0]}-auth-token`,d={db:yr,realtime:br,auth:Object.assign(Object.assign({},wr),{storageKey:l}),global:_r},h=Or(s??{},d);this.storageKey=(n=h.auth.storageKey)!==null&&n!==void 0?n:"",this.headers=(i=h.global.headers)!==null&&i!==void 0?i:{},h.accessToken?(this.accessToken=h.accessToken,this.auth=new Proxy({},{get:(u,f)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(f)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((o=h.auth)!==null&&o!==void 0?o:{},this.headers,h.global.fetch),this.fetch=Sr(t,this._getAccessToken.bind(this),h.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},h.realtime)),this.rest=new Ns(new URL("rest/v1",c).href,{headers:this.headers,schema:h.db.schema,fetch:this.fetch}),h.accessToken||this._listenForAuthEvents()}get functions(){return new vs(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}get storage(){return new vr(this.storageUrl.href,this.headers,this.fetch)}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return kn(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:s}=yield this.auth.getSession();return(t=(e=s.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,storageKey:i,flowType:o,lock:a,debug:c},l,d){const h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new bn({url:this.authUrl.href,headers:Object.assign(Object.assign({},h),l),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,flowType:o,lock:a,debug:c,fetch:d,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new tr(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,s)=>{this._handleTokenChanged(t,"CLIENT",s==null?void 0:s.access_token)})}_handleTokenChanged(e,t,s){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==s?this.changedAccessToken=s:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const $n=(r,e,t)=>new En(r,e,t),P=$n("https://ofzplydqwuuxnxtsymbl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9menBseWRxd3V1eG54dHN5bWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2OTEzMDAsImV4cCI6MjA2NzI2NzMwMH0.s4EZ2KOD-_Y_sszbQXdk2Kx1nPT_S5TE364vlQkIImE"),ss="44586f891977911675d186d6e794d464",Sn="https://api.themoviedb.org/3",te="https://image.tmdb.org/t/p/w500",_e="https://image.tmdb.org/t/p/original";document.getElementById("movies-grid");document.getElementById("tvshows-grid");document.getElementById("trending-grid");document.getElementById("hero-slider");const Tn=document.getElementById("search"),An=document.getElementById("mobile-search"),rs=document.getElementById("genre-select"),ns=document.getElementById("mobile-genre-select"),On=document.getElementById("content-type"),Pn=document.getElementById("mobile-content-type"),$t=document.getElementById("home"),St=document.getElementById("movies"),Tt=document.getElementById("tvshows"),At=document.getElementById("anime"),Ot=document.getElementById("profile"),Pt=document.getElementById("theme-toggle"),W=document.getElementById("main"),jn=document.getElementById("mobile-menu-toggle"),ce=document.getElementById("mobile-sidebar-menu"),Cn=document.querySelector(".close-mobile-menu"),jt=document.querySelectorAll(".mobile-nav-link");jn.addEventListener("click",()=>{ce.classList.add("active")});Cn.addEventListener("click",()=>{ce.classList.remove("active")});ce.addEventListener("click",r=>{r.target===ce&&ce.classList.remove("active")});jt.forEach(r=>{r.addEventListener("click",e=>{e.preventDefault();const t=r.dataset.page;jt.forEach(s=>s.classList.remove("active")),r.classList.add("active"),document.querySelectorAll(".nav-links a").forEach(s=>s.classList.remove("active")),document.getElementById(t).classList.add("active"),ce.classList.remove("active"),J(t)})});async function In(r,e){if(!T){alert("Please login to add items to your watchlist");return}try{const{error:t}=await P.from("user_watchlist").insert({user_id:T.id,content_id:r.id.toString(),content_type:e,title:e==="movie"?r.title:r.name,poster_path:r.poster_path,genres:r.genres?r.genres.map(s=>s.name||s):[]});if(t)throw t}catch(t){t.code==="23505"?alert("Item already in watchlist"):(console.error("Error adding to watchlist:",t),alert("Failed to add to watchlist"))}}async function is(r,e){if(T)try{const{error:t}=await P.from("user_watchlist").delete().eq("user_id",T.id).eq("content_id",r).eq("content_type",e);if(t)throw t;alert("Removed from watchlist!")}catch(t){console.error("Error removing from watchlist:",t),alert("Failed to remove from watchlist")}}async function Ln(r,e,t=0,s=!1){if(T)try{const{error:n}=await P.from("user_watch_history").upsert({user_id:T.id,content_id:r.id.toString(),content_type:e,title:e==="movie"?r.title:r.name,poster_path:r.poster_path,genres:r.genres?r.genres.map(i=>i.name||i):[],watch_duration:t,completed:s,watched_at:new Date().toISOString()},{onConflict:"user_id,content_id,content_type"});if(n)throw n}catch(n){console.error("Error adding to watch history:",n)}}let T=null;P.auth.getSession().then(({data:{session:r}})=>{T=(r==null?void 0:r.user)||null,ct()});P.auth.onAuthStateChange((r,e)=>{T=(e==null?void 0:e.user)||null,ct()});function ct(){const r=document.querySelector(".auth-container"),e=document.querySelector(".user-info"),t=document.querySelector(".mobile-auth-buttons"),s=document.querySelector(".mobile-user-info");T?(r.style.display="none",e.style.display="flex",e.querySelector(".user-email").textContent=T.email,t.style.display="none",s.style.display="flex",s.querySelector(".mobile-user-email").textContent=T.email):(r.style.display="flex",e.style.display="none",t.style.display="flex",s.style.display="none")}async function Rn(r){r.preventDefault();const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value;try{const{data:s,error:n}=await P.auth.signInWithPassword({email:e,password:t});if(n)throw n;document.getElementById("login-modal").style.display="none",r.target.reset()}catch(s){alert(s.message)}}async function xn(r){r.preventDefault();const e=document.getElementById("signup-email").value,t=document.getElementById("signup-password").value;try{const{data:s,error:n}=await P.auth.signUp({email:e,password:t});if(n)throw n;alert("Check your email for the confirmation link!"),document.getElementById("signup-modal").style.display="none",r.target.reset()}catch(s){alert(s.message)}}async function Un(){try{localStorage.removeItem("supabase.auth.token"),await P.auth.signOut()}catch(r){console.log("Logout error (likely session already expired):",r.message)}ct(),showPage("home")}let Se="home",Dn=JSON.parse(localStorage.getItem("favorites"))||[],ge=JSON.parse(localStorage.getItem("comments"))||{},ze=JSON.parse(localStorage.getItem("ratings"))||{},D=[];Pt.addEventListener("click",()=>{document.body.dataset.theme=document.body.dataset.theme==="dark"?"light":"dark",Pt.textContent=document.body.dataset.theme==="dark"?"☀️":"🌙"});async function S(r){try{return await(await fetch(`${Sn}${r}${r.includes("?")?"&":"?"}api_key=${ss}`)).json()}catch(e){return console.error("Error fetching content:",e),null}}function Ct(r){const e=["anime","manga","japanese","studio","shounen","shoujo","seinen","josei","mecha","isekai","slice of life","magical girl","otaku","kawaii"],t=["JP"];return r.filter(s=>{if(s.origin_country&&s.origin_country.some(o=>t.includes(o)))return!0;const n=(s.name||s.title||"").toLowerCase(),i=(s.overview||"").toLowerCase();return e.some(o=>n.includes(o)||i.includes(o))})}async function Bn(){const r=await S("/genre/movie/list"),e=await S("/genre/tv/list"),s=[...new Set([...r.genres,...e.genres].map(n=>JSON.stringify(n)))].map(n=>JSON.parse(n));[rs,ns].forEach(n=>{for(;n.children.length>1;)n.removeChild(n.lastChild);s.forEach(i=>{const o=document.createElement("option");o.value=i.id,o.textContent=i.name,n.appendChild(o)})})}function N(r,e="movie"){const t=e==="movie"?r.title:r.name,s=r.vote_average?`⭐ ${r.vote_average.toFixed(1)}`:"No rating",n=document.createElement("div");return n.className="movie-card",n.innerHTML=`
        <div class="movie-poster-container">
            <img src="${r.poster_path?te+r.poster_path:"https://via.placeholder.com/500x750"}" 
                 alt="${t}"
                 class="movie-poster">
            ${T?`
                <div class="card-actions">
                    <button class="action-btn watchlist-btn" onclick="addToWatchlist(${JSON.stringify(r).replace(/"/g,"&quot;")}, '${e}')" title="Add to Watchlist">
                        📋
                    </button>
                </div>
            `:""}
        </div>
        <div class="movie-info">
            <h3>${t}</h3>
            <p class="rating">${s}</p>
        </div>
    `,n.addEventListener("click",i=>{if(i.target.classList.contains("action-btn")){i.stopPropagation();return}D.push({page:Se}),fe(r.id,e)}),n}async function Mn(r){const[e,t]=await Promise.all([S(`/person/${r}`),S(`/person/${r}/combined_credits`)]);if(!e||!t)return;D.push({page:"details"}),W.innerHTML=`
        <div class="details-container">
            <button class="back-button">← Back</button>
            <div class="actor-details">
                <div class="actor-info">
                    <img src="${e.profile_path?te+e.profile_path:"https://via.placeholder.com/300x450"}" 
                         alt="${e.name}" 
                         class="actor-image">
                    <div class="actor-bio">
                        <h1>${e.name}</h1>
                        <p class="birth-info">Born: ${e.birthday||"N/A"}</p>
                        <p class="place-of-birth">Place of Birth: ${e.place_of_birth||"N/A"}</p>
                        <p class="biography">${e.biography||"No biography available."}</p>
                    </div>
                </div>
                <div class="filmography">
                    <h2>Filmography</h2>
                    <div class="movies-grid">
                        ${t.cast.sort((n,i)=>i.popularity-n.popularity).slice(0,20).map(n=>{const i=n.media_type,o=i==="movie"?n.title:n.name,a=n.vote_average?`⭐ ${n.vote_average.toFixed(1)}`:"No rating";return`
                                    <div class="movie-card" onclick="showDetails(${n.id}, '${i}')">
                                        <img src="${n.poster_path?te+n.poster_path:"https://via.placeholder.com/500x750"}" 
                                             alt="${o}" 
                                             class="movie-poster">
                                        <div class="movie-info">
                                            <h3>${o}</h3>
                                            <p class="character">${n.character||"Unknown Role"}</p>
                                            <p class="rating">${a}</p>
                                        </div>
                                    </div>
                                `}).join("")}
                    </div>
                </div>
            </div>
        </div>
    `,document.querySelector(".back-button").addEventListener("click",()=>{D.pop();const n=D[D.length-1];n.type==="content"?fe(n.id,n.contentType):J(n.page)})}async function fe(r,e){var Te;const[t,s,n,i]=await Promise.all([S(`/${e}/${r}`),S(`/${e}/${r}/credits`),S(`/${e}/${r}/videos`),S(`/${e}/${r}/external_ids`)]);if(!t||!s)return;const o=e==="movie"?t.title:t.name,a=e==="movie"?t.release_date:t.first_air_date,c=e==="movie"?`${t.runtime} minutes`:`${t.number_of_seasons} seasons`,l=ze[`${e}-${r}`]||0,d=ge[`${e}-${r}`]||[],h=t.vote_average?`⭐ ${t.vote_average.toFixed(1)}`:"No rating",u=(Te=n==null?void 0:n.results)==null?void 0:Te.find(v=>v.type==="Trailer"&&v.site==="YouTube"),f=i==null?void 0:i.imdb_id,g=(v=null,$=null)=>f?e==="movie"?`https://vidsrc.icu/embed/movie/${f}`:`https://vidsrc.icu/embed/tv/${f}/${v||1}/${$||1}`:null,_=g();W.innerHTML=`
        <div class="details-container">
            <div class="details-backdrop" style="background-image: url(${_e}${t.backdrop_path})">
                <div class="details-content">
                    <div class="details-poster">
                        <button class="back-button">← Back</button>
                        <img src="${te}${t.poster_path}" alt="${o}">
                    </div>
                    <div class="details-info">
                        <h1>${o}</h1>
                        <p class="release-date">Release Date: ${a}</p>
                        <p class="runtime">Runtime: ${c}</p>
                        <p class="rating">Rating: ${h}</p>
                        <p class="overview">${t.overview}</p>
                        <div class="genres">
                            ${t.genres.map(v=>`<span class="genre">${v.name}</span>`).join("")}
                        </div>
                        
                        <div class="user-rating">
                            <h3>Your Rating</h3>
                            <div class="stars">
                                ${Array.from({length:5},(v,$)=>`
                                    <span class="star ${$<l?"active":""}" data-rating="${$+1}">⭐</span>
                                `).join("")}
                            </div>
                        </div>
                        
                        ${T?`
                            <div class="content-actions">
                                <button class="action-button watchlist-button" onclick="addToWatchlist(${JSON.stringify(t).replace(/"/g,"&quot;")}, '${e}')">
                                    📋 Add to Watchlist
                                </button>
                            </div>
                        `:""}
                    </div>
                </div>
            </div>
            
            <div class="content-section">
                ${u||vidsrcUrl?`
                    <section class="video-player-section">
                        <div class="video-controls">
                            <button class="video-btn ${u?"":"disabled"}" id="watch-trailer" ${u?"":"disabled"}>
                                🎬 Watch Trailer
                            </button>
                            <button class="video-btn ${_?"":"disabled"}" id="watch-content" ${_?"":"disabled"}>
                                ▶️ ${e==="movie"?"Watch Movie":"Watch Episode"}
                            </button>
                        </div>
                        ${e==="tv"&&t.seasons&&t.seasons.length>0?`
                            <div class="episode-selection">
                                <div class="selection-group">
                                    <label for="season-select">Season:</label>
                                    <select id="season-select">
                                        ${t.seasons.filter(v=>v.season_number>0).map(v=>`
                                                <option value="${v.season_number}">
                                                    Season ${v.season_number}
                                                </option>
                                            `).join("")}
                                    </select>
                                </div>
                                <div class="selection-group">
                                    <label for="episode-select">Episode:</label>
                                    <select id="episode-select">
                                        <option value="1">Episode 1</option>
                                    </select>
                                </div>
                            </div>
                        `:""}
                        <div class="video-container">
                            <iframe id="video-player" 
                                    src="${u?`https://www.youtube.com/embed/${u.key}`:""}"
                                    frameborder="0" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                    </section>
                `:""}

                <section class="cast-section">
                    <h2>Cast</h2>
                    <div class="cast-grid">
                        ${s.cast.slice(0,8).map(v=>`
                            <div class="cast-card" onclick="showActorDetails(${v.id})">
                                <img src="${v.profile_path?te+v.profile_path:"https://via.placeholder.com/300x450"}" 
                                     alt="${v.name}">
                                <h4>${v.name}</h4>
                                <p>${v.character}</p>
                            </div>
                        `).join("")}
                    </div>
                </section>

                <section class="comments-section">
                    <h2>Comments</h2>
                    <div class="comments-list">
                        ${d.map(v=>`
                            <div class="comment">
                                <p>${v.text}</p>
                                <span>${new Date(v.date).toLocaleDateString()}</span>
                            </div>
                        `).join("")}
                    </div>
                    <div class="add-comment">
                        <textarea class="comment-input" placeholder="Add your comment..."></textarea>
                        <button class="submit-comment">Submit Comment</button>
                    </div>
                </section>
            </div>
        </div>
    `,document.querySelector(".back-button").addEventListener("click",()=>{D.pop();const v=D[D.length-1];J(v.page)});const A=v=>{const $=document.getElementById("video-player");$&&v&&($.src=v)};if(e==="tv"&&t.seasons&&t.seasons.length>0){const v=document.getElementById("season-select"),$=document.getElementById("episode-select"),M=async I=>{try{const H=await S(`/tv/${r}/season/${I}`);if(H&&H.episodes){$.innerHTML="",H.episodes.forEach(Ae=>{const Ne=document.createElement("option");Ne.value=Ae.episode_number,Ne.textContent=`Episode ${Ae.episode_number}${Ae.name?` - ${Ae.name}`:""}`,$.appendChild(Ne)});const pe=g(I,1);pe&&A(pe)}}catch(H){console.error("Error loading episodes:",H)}};v.value&&M(parseInt(v.value)),v.addEventListener("change",()=>{const I=parseInt(v.value);M(I)}),$.addEventListener("change",()=>{const I=parseInt(v.value),H=parseInt($.value),pe=g(I,H);pe&&A(pe)})}const L=document.querySelectorAll(".star");L.forEach(v=>{v.addEventListener("click",()=>{const $=parseInt(v.dataset.rating);ze[`${e}-${r}`]=$,localStorage.setItem("ratings",JSON.stringify(ze)),L.forEach((M,I)=>{M.classList.toggle("active",I<$)})})});const j=document.querySelector(".comment-input");document.querySelector(".submit-comment").addEventListener("click",()=>{const v=j.value.trim();if(v){const $={text:v,date:new Date().toISOString()};ge[`${e}-${r}`]||(ge[`${e}-${r}`]=[]),ge[`${e}-${r}`].unshift($),localStorage.setItem("comments",JSON.stringify(ge));const M=document.querySelector(".comments-list"),I=document.createElement("div");I.className="comment",I.innerHTML=`
                <p>${$.text}</p>
                <span>${new Date($.date).toLocaleDateString()}</span>
            `,M.insertBefore(I,M.firstChild),j.value=""}});const E=document.getElementById("watch-trailer"),p=document.getElementById("watch-content"),k=document.getElementById("video-player");E&&!E.disabled&&E.addEventListener("click",()=>{k.src=`https://www.youtube.com/embed/${u.key}`,E.classList.add("active"),p&&p.classList.remove("active")}),p&&!p.disabled&&p.addEventListener("click",()=>{Ln(t,e);let v;if(e==="tv"){const $=document.getElementById("season-select"),M=document.getElementById("episode-select"),I=$?parseInt($.value):1,H=M?parseInt(M.value):1;v=g(I,H)}else v=g();v&&(k.src=v),p.classList.add("active"),E&&E.classList.remove("active")}),p&&!p.disabled?(p.classList.add("active"),e==="tv"&&_&&(k.src=_)):E&&!E.disabled&&E.classList.add("active")}async function os(){const{data:{user:r}}=await P.auth.getUser();if(!r){const e=document.getElementById("recommendations-section");e&&(e.style.display="none");return}try{const e=document.getElementById("recommendations-grid");e&&(e.innerHTML='<div class="loading">Loading personalized recommendations...</div>');const t=await Nn(r.id),s=await Fn(t,r.id);Gn(s)}catch(e){console.error("Error loading recommendations:",e);const t=document.getElementById("recommendations-grid");t&&(t.innerHTML='<div class="error-state"><h3>Unable to load recommendations</h3><p>Please try again later.</p></div>')}}async function Nn(r){try{const{data:e,error:t}=await P.from("user_watch_history").select("content_type, genres").eq("user_id",r).limit(50);if(t)throw t;const{data:s,error:n}=await P.from("user_ratings").select("content_type, genres, rating").eq("user_id",r).gte("rating",4).limit(50);if(n)throw n;const{data:i,error:o}=await P.from("user_preferences").select("preferred_genres, preferred_content_types").eq("user_id",r).maybeSingle();return qn(e,s,i)}catch(e){return console.error("Error fetching user preferences:",e),{preferredGenres:[],preferredContentTypes:["movie","tv"],confidence:0}}}function qn(r,e,t){var l,d;const s={},n={};r==null||r.forEach(h=>{n[h.content_type]=(n[h.content_type]||0)+1,h.genres&&Array.isArray(h.genres)&&h.genres.forEach(u=>{s[u]=(s[u]||0)+1})}),e==null||e.forEach(h=>{const u=h.rating===5?3:2;n[h.content_type]=(n[h.content_type]||0)+u,h.genres&&Array.isArray(h.genres)&&h.genres.forEach(f=>{s[f]=(s[f]||0)+u})});const i=Object.entries(s).sort(([,h],[,u])=>u-h).slice(0,5).map(([h])=>h),o=Object.entries(n).sort(([,h],[,u])=>u-h).map(([h])=>h),a=((l=t==null?void 0:t.preferred_genres)==null?void 0:l.length)>0?t.preferred_genres:i,c=((d=t==null?void 0:t.preferred_content_types)==null?void 0:d.length)>0?t.preferred_content_types:o.length>0?o:["movie","tv"];return{preferredGenres:a,preferredContentTypes:c,confidence:Math.min(((r==null?void 0:r.length)||0)+((e==null?void 0:e.length)||0),10)/10}}async function Fn(r,e){const t=[],s=await Jn(e),n=await Hn(),i=r.preferredGenres.map(o=>n[o]).filter(o=>o).slice(0,3);for(const o of r.preferredContentTypes.slice(0,2))try{const a=o==="movie"?"discover/movie":"discover/tv",c=new URLSearchParams({api_key:ss,sort_by:"popularity.desc","vote_average.gte":"6.5","vote_count.gte":"100",page:"1"});i.length>0&&c.append("with_genres",i.join(","));const l=await fetch(`undefined${a}?${c}`);if(!l.ok){const h=await l.text();return console.error("Trending content fetch failed:",l.status,h),[]}const d=await l.json();if(d.results){const h=d.results.filter(u=>{const f=u.id.toString();return!s.has(`${f}-${o}`)});h.forEach(u=>{u.content_type=o}),t.push(...h.slice(0,6))}}catch(a){console.error(`Error fetching ${o} recommendations:`,a)}if(t.length<8)try{const a=await(await fetch("undefined/trending/all/week?api_key=undefined")).json();if(a.results){const c=a.results.filter(l=>{const d=l.id.toString(),h=l.media_type;return!s.has(`${d}-${h}`)&&!t.some(u=>u.id===l.id)});t.push(...c.slice(0,8-t.length))}}catch(o){console.error("Error fetching trending content:",o)}return t.slice(0,12)}async function Jn(r){const e=new Set;try{const{data:t}=await P.from("user_watch_history").select("content_id, content_type").eq("user_id",r);t==null||t.forEach(i=>{e.add(`${i.content_id}-${i.content_type}`)});const{data:s}=await P.from("user_ratings").select("content_id, content_type").eq("user_id",r);s==null||s.forEach(i=>{e.add(`${i.content_id}-${i.content_type}`)});const{data:n}=await P.from("user_watchlist").select("content_id, content_type").eq("user_id",r);n==null||n.forEach(i=>{e.add(`${i.content_id}-${i.content_type}`)})}catch(t){console.error("Error fetching seen content:",t)}return e}async function Hn(){const r={};try{const t=await(await fetch("undefinedgenre/movie/list?api_key=undefined")).json(),n=await(await fetch("undefinedgenre/tv/list?api_key=undefined")).json();[...t.genres||[],...n.genres||[]].forEach(i=>{r[i.name]=i.id})}catch(e){console.error("Error fetching genre map:",e)}return r}function Gn(r){const e=document.getElementById("recommendations-grid"),t=document.getElementById("recommendations-section");if(!(!e||!t)){if(r.length===0){t.style.display="none";return}t.style.display="block",e.innerHTML="",r.forEach(s=>{const n=createMovieCard(s);e.appendChild(n)})}}async function J(r){if(Se=r,D=[{page:r}],r==="profile"){if(!T){W.innerHTML=`
                <div class="content-section">
                    <div class="auth-required">
                        <h2>Login Required</h2>
                        <p>Please login to view your profile</p>
                        <button class="auth-btn" onclick="document.getElementById('login-modal').style.display='block'">Login</button>
                    </div>
                </div>
            `;return}W.innerHTML=`
            <div class="content-section">
                <div class="profile-header">
                    <h1>My Profile</h1>
                    <p>Welcome back, ${T.email}</p>
                </div>
                
                <div class="profile-tabs">
                    <button class="tab-btn active" data-tab="watchlist">My Watchlist</button>
                    <button class="tab-btn" data-tab="history">Watch History</button>
                </div>
                
                <div class="tab-content">
                    <div id="watchlist-tab" class="tab-pane active">
                        <div class="section-header">
                            <h2>My Watchlist</h2>
                            <p>Items you want to watch later</p>
                        </div>
                        <div class="movies-grid" id="watchlist-grid">
                            <div class="loading">Loading watchlist...</div>
                        </div>
                    </div>
                    
                    <div id="history-tab" class="tab-pane">
                        <div class="section-header">
                            <h2>Watch History</h2>
                            <p>Content you've recently watched</p>
                        </div>
                        <div class="movies-grid" id="history-grid">
                            <div class="loading">Loading watch history...</div>
                        </div>
                    </div>
                </div>
            </div>
        `;const a=document.querySelectorAll(".tab-btn"),c=document.querySelectorAll(".tab-pane");a.forEach(l=>{l.addEventListener("click",()=>{const d=l.dataset.tab;a.forEach(h=>h.classList.remove("active")),l.classList.add("active"),c.forEach(h=>h.classList.remove("active")),document.getElementById(`${d}-tab`).classList.add("active"),d==="watchlist"?st():d==="history"&&Wn()})}),st()}else r==="movies"?W.innerHTML=`
            <div class="hero-section splide">
                <div class="splide__track">
                    <div class="splide__list" id="hero-slider"></div>
                </div>
            </div>
            <div class="content-section">
                <h2>Trending Movies</h2>
                <div class="movies-grid" id="trending-grid"></div>
                
                <h2>Popular Movies</h2>
                <div class="movies-grid" id="movies-grid"></div>
            </div>
        `:r==="tvshows"?W.innerHTML=`
            <div class="hero-section splide">
                <div class="splide__track">
                    <div class="splide__list" id="hero-slider"></div>
                </div>
            </div>
            <div class="content-section">
                <h2>Trending TV Shows</h2>
                <div class="movies-grid" id="trending-grid"></div>
                
                <h2>Popular TV Shows</h2>
                <div class="movies-grid" id="tvshows-grid"></div>
            </div>
        `:r==="anime"?W.innerHTML=`
            <div class="hero-section splide">
                <div class="splide__track">
                    <div class="splide__list" id="hero-slider"></div>
                </div>
            </div>
            <div class="content-section">
                <h2>Trending Anime</h2>
                <div class="movies-grid" id="trending-grid"></div>
                
                <h2>Popular Anime</h2>
                <div class="movies-grid" id="anime-grid"></div>
            </div>
        `:W.innerHTML=`
            <div class="hero-section splide">
                <div class="splide__track">
                    <div class="splide__list" id="hero-slider"></div>
                </div>
            </div>
            <div class="content-section">
                <div id="recommendations-section" style="display: none;">
                    <h2>Recommended for You</h2>
                    <div class="movies-grid" id="recommendations-grid"></div>
                </div>
                
                <h2>Trending Now</h2>
                <div class="movies-grid" id="trending-grid"></div>
                
                <h2>Popular Movies</h2>
                <div class="movies-grid" id="movies-grid"></div>
                
                <h2>Popular TV Shows</h2>
                <div class="movies-grid" id="tvshows-grid"></div>
            </div>
        `;const e=document.getElementById("hero-slider"),t=document.getElementById("trending-grid"),s=document.getElementById("movies-grid"),n=document.getElementById("tvshows-grid"),i=document.getElementById("anime-grid");switch(r){case"home":const a=await S("/trending/all/week"),c=await S("/movie/popular"),l=await S("/tv/popular");a.results.slice(0,5).forEach(p=>{const k=document.createElement("div");k.className="splide__slide",k.innerHTML=`
                    <div class="hero-slide" style="background-image: url(${_e}${p.backdrop_path})">
                        <div class="hero-content">
                            <h2>${p.title||p.name}</h2>
                            <p>${p.overview}</p>
                            <div class="hero-buttons">
                                <button class="hero-btn primary" data-id="${p.id}" data-type="${p.title?"movie":"tv"}">
                                    Watch Now
                                </button>
                                <button class="hero-btn secondary" data-id="${p.id}" data-type="${p.title?"movie":"tv"}">
                                    More Info
                                </button>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(k)}),new Splide(".splide",{type:"fade",rewind:!0,autoplay:!0,interval:5e3}).mount(),os(),a.results.forEach(p=>{const k=p.media_type||(p.title?"movie":"tv");t.appendChild(N(p,k))}),c.results.forEach(p=>{s.appendChild(N(p,"movie"))}),l.results.forEach(p=>{n.appendChild(N(p,"tv"))});break;case"movies":const d=await S("/trending/movie/week"),h=await S("/movie/popular");h.results.slice(0,5).forEach(p=>{const k=document.createElement("div");k.className="splide__slide",k.innerHTML=`
                    <div class="hero-slide" style="background-image: url(${_e}${p.backdrop_path})">
                        <div class="hero-content">
                            <h2>${p.title}</h2>
                            <p>${p.overview}</p>
                            <div class="hero-buttons">
                                <button class="hero-btn primary" data-id="${p.id}" data-type="movie">
                                    Watch Now
                                </button>
                                <button class="hero-btn secondary" data-id="${p.id}" data-type="movie">
                                    More Info
                                </button>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(k)}),new Splide(".splide",{type:"fade",rewind:!0,autoplay:!0,interval:5e3}).mount(),d.results.forEach(p=>{t.appendChild(N(p,"movie"))}),h.results.forEach(p=>{s.appendChild(N(p,"movie"))});break;case"tvshows":const u=await S("/trending/tv/week"),f=await S("/tv/popular");f.results.slice(0,5).forEach(p=>{const k=document.createElement("div");k.className="splide__slide",k.innerHTML=`
                    <div class="hero-slide" style="background-image: url(${_e}${p.backdrop_path})">
                        <div class="hero-content">
                            <h2>${p.name}</h2>
                            <p>${p.overview}</p>
                            <div class="hero-buttons">
                                <button class="hero-btn primary" data-id="${p.id}" data-type="tv">
                                    Watch Now
                                </button>
                                <button class="hero-btn secondary" data-id="${p.id}" data-type="tv">
                                    More Info
                                </button>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(k)}),new Splide(".splide",{type:"fade",rewind:!0,autoplay:!0,interval:5e3}).mount(),u.results.forEach(p=>{t.appendChild(N(p,"tv"))}),f.results.forEach(p=>{n.appendChild(N(p,"tv"))});break;case"anime":const[g,_,w]=await Promise.all([S("/discover/tv?with_genres=16&sort_by=popularity.desc&with_origin_country=JP"),S("/discover/tv?with_origin_country=JP&sort_by=popularity.desc"),S("/discover/tv?with_keywords=210024|287928&sort_by=popularity.desc")]),L=[...(g==null?void 0:g.results)||[],...(_==null?void 0:_.results)||[],...(w==null?void 0:w.results)||[]].filter((p,k,Te)=>k===Te.findIndex(v=>v.id===p.id)),j=Ct(L),C=await S("/trending/tv/week?with_origin_country=JP"),E=Ct((C==null?void 0:C.results)||[]);j.slice(0,5).forEach(p=>{const k=document.createElement("div");k.className="splide__slide",k.innerHTML=`
                    <div class="hero-slide" style="background-image: url(${_e}${p.backdrop_path})">
                        <div class="hero-content">
                            <h2>${p.name}</h2>
                            <p>${p.overview}</p>
                            <div class="hero-buttons">
                                <button class="hero-btn primary" data-id="${p.id}" data-type="tv">
                                    Watch Now
                                </button>
                                <button class="hero-btn secondary" data-id="${p.id}" data-type="tv">
                                    More Info
                                </button>
                            </div>
                        </div>
                    </div>
                `,e.appendChild(k)}),new Splide(".splide",{type:"fade",rewind:!0,autoplay:!0,interval:5e3}).mount(),E.slice(0,20).forEach(p=>{t.appendChild(N(p,"tv"))}),j.slice(0,20).forEach(p=>{i.appendChild(N(p,"tv"))});break;case"favorites":Dn.forEach(p=>{(p.contentType==="movie"?s:n).appendChild(N(p,p.contentType))});break}document.querySelectorAll(".hero-btn").forEach(a=>{a.addEventListener("click",()=>{const c=a.dataset.id,l=a.dataset.type;D.push({type:"content",id:c,contentType:l}),fe(c,l)})})}async function st(){if(!T)return;const r=document.getElementById("watchlist-grid");if(r)try{const{data:e,error:t}=await P.from("user_watchlist").select("*").eq("user_id",T.id).order("added_at",{ascending:!1});if(t)throw t;if(r.innerHTML="",e.length===0){r.innerHTML=`
                <div class="empty-state">
                    <h3>Your watchlist is empty</h3>
                    <p>Add movies and TV shows you want to watch later</p>
                </div>
            `;return}e.forEach(s=>{const n=zn(s);r.appendChild(n)})}catch(e){console.error("Error loading watchlist:",e),r.innerHTML=`
            <div class="error-state">
                <h3>Error loading watchlist</h3>
                <p>Please try again later</p>
            </div>
        `}}async function Wn(){if(!T)return;const r=document.getElementById("history-grid");if(r)try{const{data:e,error:t}=await P.from("user_watch_history").select("*").eq("user_id",T.id).order("watched_at",{ascending:!1}).limit(50);if(t)throw t;if(r.innerHTML="",e.length===0){r.innerHTML=`
                <div class="empty-state">
                    <h3>No watch history</h3>
                    <p>Start watching content to see your history here</p>
                </div>
            `;return}e.forEach(s=>{const n=Kn(s);r.appendChild(n)})}catch(e){console.error("Error loading watch history:",e),r.innerHTML=`
            <div class="error-state">
                <h3>Error loading watch history</h3>
                <p>Please try again later</p>
            </div>
        `}}function zn(r){const e=document.createElement("div");return e.className="movie-card watchlist-card",e.innerHTML=`
        <div class="movie-poster-container">
            <img src="${r.poster_path?te+r.poster_path:"https://via.placeholder.com/500x750"}" 
                 alt="${r.title}"
                 class="movie-poster">
            <div class="card-actions">
                <button class="action-btn remove-btn" onclick="removeFromWatchlistAndRefresh('${r.content_id}', '${r.content_type}')" title="Remove from Watchlist">
                    ❌
                </button>
            </div>
        </div>
        <div class="movie-info">
            <h3>${r.title}</h3>
            <p class="added-date">Added ${new Date(r.added_at).toLocaleDateString()}</p>
            <div class="genres">
                ${r.genres.slice(0,2).map(t=>`<span class="genre-tag">${t}</span>`).join("")}
            </div>
        </div>
    `,e.addEventListener("click",t=>{if(t.target.classList.contains("action-btn")){t.stopPropagation();return}D.push({page:Se}),fe(r.content_id,r.content_type)}),e}function Kn(r){const e=document.createElement("div");return e.className="movie-card history-card",e.innerHTML=`
        <div class="movie-poster-container">
            <img src="${r.poster_path?te+r.poster_path:"https://via.placeholder.com/500x750"}" 
                 alt="${r.title}"
                 class="movie-poster">
            ${r.completed?'<div class="completed-badge">✓</div>':""}
        </div>
        <div class="movie-info">
            <h3>${r.title}</h3>
            <p class="watch-date">Watched ${new Date(r.watched_at).toLocaleDateString()}</p>
            ${r.watch_duration>0?`<p class="duration">Duration: ${Math.floor(r.watch_duration/60)}m</p>`:""}
            <div class="genres">
                ${r.genres.slice(0,2).map(t=>`<span class="genre-tag">${t}</span>`).join("")}
            </div>
        </div>
    `,e.addEventListener("click",()=>{D.push({page:Se}),fe(r.content_id,r.content_type)}),e}async function Vn(r,e){await is(r,e),st()}function as(r,e,t){r.addEventListener("input",Yn(async s=>{const n=s.target.value.trim(),i=e.value,o=t.value;if(!n&&!o){J(Se);return}let a="/discover",c=[];i!=="all"?a+=`/${i}`:a+="/movie",o&&c.push(`with_genres=${o}`),n&&(c.push(`&query=${encodeURIComponent(n)}`),a=`/search/${i==="all"?"multi":i}`);const l=await S(`${a}?${c.join("&")}`);l&&l.results&&Qn(l.results,i)},500))}as(Tn,On,rs);as(An,Pn,ns);function Qn(r,e){W.innerHTML=`
        <div class="content-section">
            <h2>Search Results</h2>
            <div class="movies-grid" id="search-results"></div>
        </div>
    `;const t=document.getElementById("search-results");r.forEach(s=>{(e==="all"||s.media_type===e||!s.media_type)&&t.appendChild(N(s,s.media_type||e))})}$t.addEventListener("click",r=>{r.preventDefault(),document.querySelectorAll(".nav-links a").forEach(e=>e.classList.remove("active")),$t.classList.add("active"),J("home")});St.addEventListener("click",r=>{r.preventDefault(),document.querySelectorAll(".nav-links a").forEach(e=>e.classList.remove("active")),St.classList.add("active"),J("movies")});Tt.addEventListener("click",r=>{r.preventDefault(),document.querySelectorAll(".nav-links a").forEach(e=>e.classList.remove("active")),Tt.classList.add("active"),J("tvshows")});At.addEventListener("click",r=>{r.preventDefault(),document.querySelectorAll(".nav-links a").forEach(e=>e.classList.remove("active")),At.classList.add("active"),J("anime")});Ot.addEventListener("click",r=>{r.preventDefault(),document.querySelectorAll(".nav-links a").forEach(e=>e.classList.remove("active")),Ot.classList.add("active"),J("profile")});function Yn(r,e){let t;return function(...n){const i=()=>{clearTimeout(t),r(...n)};clearTimeout(t),t=setTimeout(i,e)}}window.showDetails=fe;window.showActorDetails=Mn;window.handleLogin=Rn;window.handleSignup=xn;window.handleLogout=Un;window.addToWatchlist=In;window.removeFromWatchlist=is;window.removeFromWatchlistAndRefresh=Vn;document.addEventListener("DOMContentLoaded",()=>{Bn(),J("home"),os()});export{Xn as g};
